# Database
## Many To Many Relationships
### 팔로우 기능 구현 
### 프로필 페이지
- 각 회원의 개인 프로필 페이지에 팔로우 기능을 구현하기 위해 프로필 페이지 먼저 구현하기
- 프로필 페이지에 해당 사용자의 추가 정보를 같이 볼 수 있게 내용 추가
  - 해당 사용자가 작성한 게시글 목록
  - 해당 사용자가 작성한 댓글 목록
  - 해당 사용자가 좋아요를 누른 게시글 목록

### 프로필 페이지 구현(1)
- 프로필 페이지로 접근하기 위한 URL 주소 작성
  - 프로필 페이지는 사용자와 관련된 기능이기 때문에 'accounts'앱의 'urls.py'에 추가
  - 로그인한 유저 뿐만 아니라 다른 사람의 프로필 페이지 방문도 가능해야 함
  - 사용자의 username을 variable routing을 활용하여 정보 전달이 필요

```python 
# accounts/urls.py

app_name = 'accounts'
urlpartterns = [
  path('login/', views.login, name='login'),
  path('logout/', views.logout, name='logout'),
  ...
  path('profile/<username>/', views.profile, name='profile'),
]
```


### 프로필 페이지 구현(2)
- view 함수 작성
  - URL로 전달되는 username을 이용하여 사용자 정보를 조회하고 이를 template으로 전달
  - 유저 모델은 직접 import 하지 않고, get_user_model()함수를 사용해야 함

```python
# accounts/views.py

from django.contrib.auth import get_user_model

def profile(request, username):
  User = get_user_model()
  person = User.objects.get(username=username)
  context = {
    'person' : person,
  }
  return render(request, 'accounts/profile.html', context)
```


### 프로필 페이지 구현(3)
- 프로필 페이지의 세부 내용을 작성

```html
<!-- accounts/profile.html -->

<h1>{{ person.username }}님의 프로필</h1>
<hr>

<h2>{{ person.username }}가 작성한 게시글</h2>
{% for article in person.article_set.all %}
  <div>{{ article.title }}</div>
{% endfor %}
<hr>

<h2>{{ person.username }}가 작성한 댓글</h2>
{% for comment in person.comment_set.all %}
  <div>{{ comment.content }}</div>
{% endfor %}
<hr>

<h2>{{ person.username }}가 좋아요한 게시글</h2>
{% for article in person.like_articles.all %}
  <div>{{ article.title }}</div>
{% endfor %}
```


### 프로필 페이지 구현(4)
- index 페이지에서 내 프로필로 이동할 수 있도록 프로필 링크 추가
```html
<!-- articles/index.html -->

<h1>Articles</h1>
{% if request.user.is_authenticated %}
  <h3>Hello, {{ user.username }}</h3>
  <a href="{% url 'accounts:profile' user.username %}">내 프로필</a>
  <a href="{% url 'articles:create' %}">NEW</a>

  ...
{% endif %}
<hr>
```

### 프로필 페이지 구현(5)
- 다른 유저의 프로필 페이지로 이동할 수 있도록 유저 아이디에도 해당 유저의 프로필 링크 추가

```html
<!-- articles/index.html -->
...

{% for article in articles %}
  <p>작성자 : <a href="{% url 'accounts:profile' article.user.username %}"> {{ article.user }}</a></p>
  ...
  <hr>
{% endfor %}
```

---

## 모델 관계 설정
### 팔로우 기능의 모델 관계
`User(M) - User(N)`

- 팔로우는 유저와 유저와의 관계를 나타냄
-> 회원은 여러 명의 회원을 팔로우 할 수 있고, 한 명도 하지 않을 수도 있음
-> 회원은 여러 명의 팔로워를 가질 수 있고, 한 명도 가지지 않을 수도 있음

### 팔로우 모델 관계 설정
- 커스텀한 User 모델 클래스에 ManyToManyField를 사용하여 팔로우 필드를 추가
  - User 모델과 관계를 맺는 것이기 때문에 settings.AUTY_USER_MODEL을 사용해도 되지만 자기 자신과의 관계이기 대문에 'self'로 표현할 수 있음
  - 팔로우 기능은 단방향의 관계이기 때문에 반드시 symmetrical 속성을 False로 설정
  - 참조 필드는 followings 필드로 내가 팔로우하는 사람들을 의미
  - 역참조 필드는 user_set을 사용해도 되지만 명확한 설정을 위해 related_name을 이용하여 'followers'로 변경

```python 
# accounts/models.py

class User(AbstractUser):
  followings = models.ManyToManyField('self', symmetrical=False, related_name='followers')
```

* 참조, 역참조는 서로 바뀌어도 상관없으나 관계 조회시 생각하기 편한 방향으로 정하여 작성됨 


---


## 기능 구현
### 팔로우 기능 구현(1)
- 팔로우 기능을 위한 URL 추가
  - 어느 사용자를 팔로우 하는지 상대 사용자에 대한 정보를 variable routing을 활용하여 전달

```python 
# accounts/urls.py

app_name='accounts'
url_patterns = [
  path('login/', views.login, name='login'),
  ...
  path('profile/<uasername>/', views.profile, name='profile')
  path('<int:user_pk>/follow/', views.follow, name='follow'),
]
```

### 팔로우 기능 구현(2)
- 중개 테이블에 이미 내 정보가 있으면 제거(팔로우 해제)
- 중개 테이블에 내 정보가 없으면 추가(팔로우 진행)

```python 
# accounts/views.py
@login_required
def follow(request, user_pk):
  User = get_user_model()
  person = User.objects.get(pk=user_pk)

  if person != request.user:
    if request.user in person.followers.all():
      person.followers.remove(request.user)
    else:
      person.followers.add(request.user)

  return redirect('accounts:profile', person.username)
```

### 팔로우 기능 구현(3)
- 프로필 페이지에서 팔로우 기능을 추가
  - 팔로우와 팔로잉이 몇 명 있는지 DTL을 사용하여 출력하는 부분 추가

```html
<!-- accounts/profile.html -->

<h1>{{ person.username }}님의 프로필</h1>
<div>
  <div>
    팔로잉 : {{ person.followings.all|length }} / 팔로워 : {{ person.foolowers.all|length }}
  </div>
...
```

### 팔로우 기능 구현(4)
- 프로필 페이지에서 팔로우 기능을 추가
  - 프로필 페이지의 유저(person)가 로그인한 사용자(request.user)의 페이지인 경우 팔로우 버튼 숨기기 
  - 팔로우를 수행할 버튼을 추가하고 팔로우 여부에 따라 버튼의 텍스트를 다르게 출력

```html
{% if request.user != person %}
  <div>
    <form action="{% url 'accounts:follow' person.pk %}" method="POST">
      {% csrf_token %}
      {% if request.user in person.followers.all %}
        <input type="submit" value="Unfollow">
      {% else %}
        <input type="submit" value="Follow">
      {% endif %}
    </form>
  </div>
{% endif %}
```

### 팔로우 기능 구현(5)
- 팔로우 기능 확인
  - 팔로우 버튼을 눌렀을 때 숫자와 버튼 텍스트
  - 내 프로필에서 팔로우 버튼 생략

- 팔로우 버튼 클릭 후 중개 테이블 데이터 확인
  - from_user_id는 버튼을 누른 유저(나)
  - to_user_id는 팔로우된 유저(상대방)


---


## Fixtures
- Django 개발 시 데이터 베이스 초기화 및 공유를 위해 사용되는 파일 형식


### Fixtures 사용 목적
- 초기 데이터 세팅 
  - 웹 서비스가 처음 시작될 때 필요한 기본 데이터(기본 권한 그룹, 상품 카테고리 등)를 미리 세팅할 수 있음
- 데이터 샘플 데이터 준비
  - 테스트할 때, 항상 동일하고 예측 가능한 데이터 환경을 구축하여 테스트의 신뢰성과 반복 가능성을 높이는 데 활용
- 협업 시 동일한 데이터 환경 맞추기
  - 팀원들이 각자의 개발 환경을 설정할 때, 모두 동일한 초디 데이터나 특정 테스트 데이터 셋을 쉽게 공유하고 적용
  - 개발 환경 간의 일관성을 유지하고 협업 효율을 높이는 데 도움을 줌


### 초기 데이터의 필요성
- 협업하는 유저 A, B가 있다고 생각 했을 때
  1. A가 먼저 프로젝트를 작업 후 원격 저장소에 push 진행
    - .gitignore로 인해 DB는 업로드하지 않기 때문에 A가 생성한 데이터도 업로드 X
  2. B가 원격 저장소에서 A가 push한 프로젝트를 pull (혹은 clone)
    - 결과적으로 B는 DB가 없는 프로젝트를 받게 됨 
- 이처럼 프로젝트의 앱을 처음 설정할 때 동일하게 준비 된 데이터로 데이터베이스를 미리 채우는 것이 필요한 순간이 있음
- Django에서는 fixtures를 사용해 앱에 초기 데이터(initial data)를 제공


### fixtures 관련 명령어
- 'dumpdata'
  - 데이터베이스에서 데이터를 내보낼 때 사용하는 명령어
  - 주로 파일(JSON) 형태로 추출함
  - 특정 테이블의 데이터만 추출도 가능함
- 'loaddata'
  - 데이터베이스에 데이터를 불러올 때 사용하는 명령어
  - 내보내기 형태로 저장된 JSON을 읽어와서 데이터베이스에 저장함 

### Fixtures 실습 사전 준비
- M:N 까지 모두 작성된 Django 프로젝트에서 유저, 게시글, 댓글 데이터 준비하기 