# Javascript
## Ajax with Django
### Ajax with follow
### 비동기 팔로우 구현 - Ajax 적용(1)
- 프로필 페이지에 axios CDN 작성

```html
<!-- accounts/profile.html -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
</script>
</body>
</html>
```


### 비동기 팔로우 구현 - Ajax 적용(2)
- form 요소 선택을 위해 id 속성 지정 및 선택
- action과 method 속성은 삭제 
  -> 요청은 axios로 대체할 예정 

```html
<!-- accounts/profile.html -->
<form id='follow-form'>
  ...
</form>
```

```html
<!-- accounts/profile.html -->
<script>
const formTag = docuemnt.querySelector('#follow-form')
</script>
```


### 비동기 팔로우 구현 - Ajax 적용(3)
- form 요소에 이벤트 핸들러 할당
- submit 이벤트의 기본 동작 취소하기

```html
<!-- accounts/profile.html -->
<script>
formTag.addEventListener('submit', function(event){
  event.preventDefault()
})
</script>
```


### 비동기 팔로우 구현 - Ajax 적용(4)
- axios 요청 코드 작성
  1. 요청 url에 필요한 사용자 pk는 어떻게 작성해야 할까?
  2. CSRF 토큰은 어떻게 보내야 할까?

```html
<!-- accounts/profile.html -->
<script>
formTag.addEventListener('submit', function(event){
  event.preventDefault()
  axios({
    method: 'post', 
    url: `/accounts/${}/follow/`,
  })
})
</script>
```


### 비동기 팔로우 구현 - Ajax 적용(5)
- url에 작성할 user pk 가져오기(HTML => JavaScript)

```html
<!-- accounts/profile.html -->
<form id="follow-form" data-user-id="{{ person.pk }}">
  ...
</form>
```

```html
<!-- accounts/profile.html -->
<script>
formTag.addEventListener('submit', function(event){
  event.preventDefault()
  const userId = event.cuurentTarget.dataset.userId
  const userId = this.dataset.userId
  const userId = formTag.dataset.userId
})
</script>
```


### 'data-*' 속성
- 사용자 지정 데이터 속성을 만들어, HTML과 DOM 사이에서 임의의 데이터를 교환하는 방법
- 모든 사용자 지정 데이터는 JavaScript에서 **dataset 속성**을 통해 접근
- 주의사항
  - 대소문자 여부에 상관없이 'xml' 문자로 시작 불가
  - 세미콜론 포함 불가
  - 대문자 포함 불가

```html
<!-- accounts/profile.html -->
<div data-my-id="{{ person.pk }}"></div>

<script>
  const userId = event.target.dataset.myId
</script>
```


### 비동기 팔로우 구현 - Ajax 적용(6)
- 요청 url 작성 마무리 

```html
<!-- accounts/profile.html -->
<script>
formTag.addEventListener('submit', function(event){
  event.preventDefault()

  const userId = event.cuurentTarget.dataset.userId

  axios({
    method: 'post', 
    url: `/accounts/${userId}/follow/`,
  })
})
</script>
```


### 비동기 팔로우 구현 - Ajax 적용(7)
- 문서상 input hidden 타입으로 존재하는 csrf token 데이터를 이제는 **axios**로 전송해야 함

```html
<!-- accounts/profile.html -->
<form id="follow-form" data-user-id="{{ person.pk }}">
  {% csrf_token %}

  {% if request.user in person.followers.all %}
    <input type='submit' value='Unfollow'>

  {% else %}
    <input type='submit' value='Follow'>

  {% endif %}
</form>
```


### 비동기 팔로우 구현 - Ajax 적용(8)
- 문서상 input hidden 타입으로 존재하는 csrf token 데이터를 이제는 **axios**로 전송해야 함

```html
<!-- accounts/profile.html -->

<script>

const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

formTag.addEventListener('submit', function(event){
  event.preventDefault()

  const userId = event.cuurentTarget.dataset.userId

  axios({
    method: 'post', 
    url: `/accounts/${userId}/follow/`,
    headers: {'X-CSRFToken': csrftoken,},
  })
})
</script>
```


### 비동기 팔로우 구현 - Ajax 적용(9)
- 팔로우 버튼을 토글하기 위해서는 현재 팔로우 상태인지 언팔로우 상태인지에 대한 상태 확인이 필요
- Django의 view 함수에서, **팔로우 여부를 나타내는 변수(is_followed)**를 추가하여 JSON 형식으로 응답
- 팔로우 상태 여부를 JavaScript에게 전달할 데이터 작성
- 응답은 HTML 문서가 아닌 **JSON 데이터로 응답**하도록 변경 (**JsonResponse**활용)

```python
from django.http import JsonResponse

@login_required
def follow(request, user_pk):
    User = get_user_model()

    person = User.objects.get(pk=user_pk)
    if person != request.user:
        if person.followers.filter(pk=request.user.pk).exists():
            person.followers.remove(request.user)
            is_followed = False
        else:
            person.followers.add(request.user)
            is_followed = True
        context = {
            'is_followed': is_followed,
            'followings_count': person.followings.count(),
            'followers_count': person.followers.count()
        }
        return JsonResponse(context)
    return redirect('accounts:profile', person.username)
```


### 비동기 팔로우 구현 - Ajax 적용(10)
- 팔로우 요청 후 Django 서버로 부터 받은 응답 데이터 확인하기 

```html
<!-- accounts/profile.html -->

<script>
formTag.addEventListener('submit', function(event){
  event.preventDefault()
  const userId = event.cuurentTarget.dataset.userId

  axios({
    method: 'post', 
    url: `/accounts/${userId}/follow/`,
    headers: {'X-CSRFToken': csrftoken,},
  }).then((response) => {
    console.log(response)
    console.log(response.data)
  })
})
</script>
```


### 비동기 팔로우 구현 - Ajax 적용(11)
- 응답 데이터 is_followed에 따라 팔로우 버튼을 조작하기 

```html
<!-- accounts/profile.html -->

<script>
  axios({
    method: 'post', 
    url: `/accounts/${userId}/follow/`,
    headers: {'X-CSRFToken': csrftoken,},
  }).then((response) => {
    const isFollowed = response.data.is_followed
    const followBtn = document.querySelector('input[type=submit]')

    if(isFollowed === true){
      followBtn.value = 'UnFollow'
    }else{
      followBtn.value = 'Follow'
    }
  })
</script>
```


### 비동기 팔로우 구현 - Ajax 적용(12)
- 클라이언트와 서버 간 XHR 객체를 주고 받는 것을 확인하기 
- 개발자도구 - Network


### 비동기 팔로우 구현 - Ajax 적용(13)
- '팔로잉 수와 팔로우 수 비동기 적용'
- Django viwe 함수에서 팔로워, 팔로잉 인원 수 연산을 진행하여 결과를 응답 데이터로 전달

```python 
# accounts/viwes.py

@ login_required
def follow(request, user_pk):
  ...
  context = {
              'is_followed' : is_followed,
              'followings_count': person.followings.count(),
              'followers_count': person.followers.count(),
          }
          return JsonResponse(context)
      return redirect('accounts:profile', person.username)
```


### 비동기 팔로우 구현 - Ajax 적용(14)
- 해당 요소를 선택할 수 있도록 span 태그와 id 속성 작성
- 각 span 태그를 선택 후 응답 데이터를 받아 각 태그의 인원 수 값 변경에 활용

```html
<!-- accounts/profile.html -->
<div>
팔로워 : <span id="followers_count">{{ person.followers.all|length }}</span> / 
팔로잉 : <span id="followings_count">{{ person.followings.all|length }}</span>
</div>
```

```html
<!-- accounts/profile.html -->
<script>
.then((response) => {
  const followingsCountTag = document.querySelector('#followings_count')
  const followersCountTag = document.querySelector('#followers_count')
  
  followingsCountTag.textContent = response.data.followings_count
  followersCountTag.textContent = response.data.followers_count
})
</script>
```